<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cat.manage.order.dao.SubOrderDao">
	<resultMap type="com.cat.manage.order.domain.SubOrder" id="subOrderResultMap">
		<id property="suborderId" column="suborder_id"/>
		<result property="superOrderId" column="super_order_id"/>
		<result property="brandId" column="brand_id"/>
		<result property="seriesId" column="series_id"/>
		<result property="singleId" column="single_id"/>
		<result property="num" column="num"/>
		<result property="orderPrice" column="order_price"/>
		<result property="transferPrice" column="transfer_price"/>
		<result property="costPrice" column="cost_price"/>
		<result property="sellingPrice" column="selling_price"/>
		<result property="curState" column="curstate"/>
		<result property="createDate" column="create_date"/>
		<result property="updateDate" column="update_date"/>
		<result property="createDateFormat" column="createDateFormat"/>
		<result property="updateDateFormat" column="updateDateFormat"/>
		<result property="brandName" column="brand_name"/>
		<result property="seriesName" column="series_name"/>
		<result property="singleName" column="single_name"/>
		<result property="sumOrderPrice" column="sum_order_price"/>
		<result property="sumTransferPrice" column="sum_transfer_price"/>
		<result property="sumCostPrice" column="sum_cost_price"/>
		<result property="sumSellingPrice" column="sum_selling_price"/>
	</resultMap>
	
	<!-- 添加订单 -->
	<insert id="addSubOrder" parameterType="com.cat.manage.order.domain.SubOrder">
		insert into t_suborder (super_order_id, brand_id, series_id, single_id, num, order_price,transfer_price, cost_price,selling_price, curstate,create_date, update_date)
		values(#{superOrderId}, #{brandId}, #{seriesId}, #{singleId}, #{num}, #{orderPrice}, #{transferPrice}, #{costPrice}, #{sellingPrice}, #{curState}, now(), now())
	</insert>
	
	<!-- 查询单个订单 -->
	<select id="querySubOrderById" parameterType="java.lang.Integer" resultMap="subOrderResultMap">
		select suborder_id, super_order_id, brand_id, series_id, single_id, num, order_price,transfer_price, cost_price,selling_price, curstate,create_date, update_date, date_format(create_date, '%Y年%m月%d日 %T') as createDateFormat, date_format(update_date, '%Y年%m月%d日 %T') as updateDateFormat 
		from t_suborder where suborder_id = #{suborderId}
	</select>
	
	
	<!-- 查询所有订单 -->
	<select id="querySubOrderAll" resultMap="subOrderResultMap">
		select suborder_id, super_order_id, brand_id, series_id, single_id, num, order_price,transfer_price, cost_price,selling_price, curstate, create_date, update_date, date_format(create_date, '%Y年%m月%d日 %T') as createDateFormat, date_format(update_date, '%Y年%m月%d日 %T') as updateDateFormat
		from t_suborder where 1=1
		<if test="startTime != null and startTime != ''">
			and DATE_FORMAT(create_date, '%Y%m%d') &gt;= #{startTime, jdbcType=VARCHAR}
		</if>
		<if test="endTime != null and endTime != ''">
			and DATE_FORMAT(create_date, '%Y%m%d') &lt;= #{endTime, jdbcType=VARCHAR}
		</if>
		
		 order by create_date desc
	</select>
	
	<!-- 查询所有子订单 -->
	<select id="querySubOrderAllForName" resultMap="subOrderResultMap">
		select suborder_id, super_order_id, brand_id, series_id, single_id, num, order_price,transfer_price, cost_price,selling_price, curstate, create_date, update_date, date_format(create_date, '%Y年%m月%d日 %T') as createDateFormat, date_format(update_date, '%Y年%m月%d日 %T') as updateDateFormat,
		(num*order_price) as sum_order_price, (num*transfer_price) as sum_transfer_price, (num*cost_price) as sum_cost_price, (num*selling_price) as sum_selling_price,
		(select brand_name from t_brand where brand_id = t.brand_id) as brand_name,
		(select series_name from t_series where series_id = t.series_id) as series_name,
		(select single_name from t_singleproduct where single_id = t.single_id) as single_name 
		from t_suborder t where 1=1
		<if test="param1.superOrderId != null and param1.superOrderId != ''">
			and super_order_id = #{param1.superOrderId}
		</if>
		<if test="param1.brandId != null and param1.brandId != ''">
			and brand_id= #{param1.brandId}
		</if>
		<if test="param1.seriesId != null and param1.seriesId != ''">
			and series_id= #{param1.seriesId}
		</if>
		<if test="param1.singleId != null and param1.singleId != ''">
			and single_id= #{param1.singleId}
		</if>
		<if test="param1.num != null and param1.num != ''">
			and num= #{param1.num}
		</if>
		<if test="param1.orderPrice != null and param1.orderPrice != ''">
			and order_price= #{param1.orderPrice}
		</if>
		<if test="param1.transferPrice != null and param1.transferPrice != ''">
			and transfer_price= #{param1.transferPrice}
		</if>
		<if test="param1.costPrice != null and param1.costPrice != ''">
			and cost_price= #{param1.costPrice}
		</if>
		<if test="param1.sellingPrice != null and param1.sellingPrice != ''">
			and selling_price= #{param1.sellingPrice}
		</if>
		<if test="param1.curState != null and param1.curState != ''">
			and curstate= #{param1.curState}
		</if>
		<if test="param2 != null and param2 != ''">
			and DATE_FORMAT(create_date, '%Y%m%d') &gt;= #{param2}
		</if>
		<if test="param3 != null and param3 != ''">
			and DATE_FORMAT(create_date, '%Y%m%d') &lt;= #{param3}
		</if>
		
		 order by create_date desc
	</select>
	
	<!-- 修改单个子订单 -->
	<update id="updateSubOrder" parameterType="com.cat.manage.order.domain.SubOrder"> 
		update t_suborder set update_date=now()
		<if test="superOrderId != null and superOrderId != ''">
			, super_order_id = #{superOrderId}
		</if>
		<if test="brandId != null and brandId != ''">
			, brand_id= #{brandId}
		</if>
		<if test="seriesId != null and seriesId != ''">
			, series_id= #{seriesId}
		</if>
		<if test="singleId != null and singleId != ''">
			, single_id= #{singleId}
		</if>
		<if test="num != null and num != ''">
			, num= #{num}
		</if>
		<if test="orderPrice != null and orderPrice != ''">
			, order_price= #{orderPrice}
		</if>
		<if test="transferPrice != null and transferPrice != ''">
			, transfer_price= #{transferPrice}
		</if>
		<if test="costPrice != null and costPrice != ''">
			, cost_price= #{costPrice}
		</if>
		<if test="sellingPrice != null and sellingPrice != ''">
			, selling_price= #{sellingPrice}
		</if>
		<if test="curState != null and curState != ''">
			, curstate= #{curState}
		</if>
		 where suborder_id = #{suborderId}
	</update>
	
	<insert id="addSubOrderForCopy" parameterType="java.lang.Integer">
		insert into t_suborder(super_order_id, brand_id, series_id, single_id, num, order_price,transfer_price, cost_price,selling_price, curstate,create_date, update_date)
		select super_order_id, brand_id, series_id, single_id, #{num,jdbcType=INTEGER} , order_price,transfer_price, cost_price,selling_price, curstate, now(), now()
		from t_suborder where suborder_id = #{subOrderId,jdbcType=INTEGER}
	</insert>
	
	
	<!-- 根据主订单编号删除子订单 -->
	<delete id="deleteSubOrderByParentId" parameterType="java.lang.Integer">
		delete from t_suborder where super_order_id = #{parentId}
	</delete>	
	
	<!-- 根据子订单编号删除子订单 -->
	<delete id="deleteSubOrderById" parameterType="java.lang.Integer">
		delete from t_suborder where suborder_id = #{suborderId}
	</delete>
	
	<!-- 修改子订单状态 -->
	<update id="updateSubOrderForStatus">
		update t_suborder set update_date=now()
		<if test="param2 != null and param2 != ''">
			, curstate= #{param2}
		</if>
		where super_order_id = #{param1}
	</update>
	
	<!-- 根据多个子订单ID查询子订单 -->
	<select id="querySubOrderByIds">
		select suborder_id, super_order_id, brand_id, series_id, single_id, num, order_price,transfer_price, cost_price,selling_price, curstate, create_date, update_date, date_format(create_date, '%Y年%m月%d日 %T') as createDateFormat, date_format(update_date, '%Y年%m月%d日 %T') as updateDateFormat
		from t_suborder where suborder_id in
		<foreach collection="param1" item="suborderId" open="(" separator="," close=")">#{suborderId}</foreach>
		<if test="param2 != null and param2 != ''">
			and curstate not in 
			<foreach collection="param2" item="state" open="(" separator="," close=")">#{state}</foreach>
		</if>
		order by create_date desc
	</select>
	
	<!-- 根据子订单ID合并子订单 -->
	<update id="updateSubOrderForMerge">
		update t_suborder set update_date=now()
			, num= (select SUM(num) from t_suborder where suborder_id in 
			<foreach collection="param2" item="id"  open="(" separator="," close=")">#{id}</foreach>
			)
			, order_price= #{param3}
			, transfer_price= #{param4}
			, cost_price= #{param5}
			, selling_price= #{param6}
			, curstate= #{param7}
		 where suborder_id = #{param1}
	</update>
	
	<!-- 根据多个ID删除子订单 -->
	<delete id="deleteSubOrderForMoreId">
		delete from t_suborder where suborder_id in
		<foreach collection="array" item="suborderId" open="(" separator="," close=")">#{suborderId}</foreach>
	</delete>
	
	
</mapper>